#!/usr/bin/python3

import requests
from bs4 import BeautifulSoup
import contrasenas

#URL de la aplicacion DVWA que corre localmente por el puerto 80
url = 'http://127.0.0.1/login.php'

#Parametros que se envian en la solicitud
parametro_usuario = 'username'
parametro_contrasena = 'password'
parametro_token = 'user_token'

#Credenciales de la aplicacion
usuario_login = "admin"
contrasena_login = "password"

#Se crea el objeto para la sesion
with requests.Session() as s:

    try:
        #Se hace una solicitud get para poder parametrizar el token de usuario 
        #y las cookies de sesion
        res = s.get(url, timeout=5)
        cookies = res.headers["Set-Cookie"]
        HTML = res.text
        sopa = BeautifulSoup(HTML,"html.parser")
        titulo = sopa.title.text

        #Mediante el titulo de la pagina se determina si es o no la aplicacion
        if titulo == 'Login :: Damn Vulnerable Web Application (DVWA) v1.10 *Development*':
            token = sopa.find("form").find("input", {"name":parametro_token})["value"]

            #Se empaquetan los parametros a enviar en un diccionario
            parametros = {parametro_usuario:usuario_login,parametro_contrasena:contrasena_login,parametro_token:token,"Login":"Login"}

            #Se empaquetan las cookies de sesion en un diccionario
            cabeceras = {"cookie":cookies,"Content-Type":"application/x-www-form-urlencoded"}
            res = s.post(url, data=parametros, headers=cabeceras, timeout=5)
            
            #Dependiendo de la redireccion se determina si la autenticacion fue exitosa
            if "index.php" in res.url:
                print("Autenticacion exitosa")
            elif "setup.php" in res.url:
                print("Debe configurarse primero la aplicacion")
            else:
                print("Autenticacion fallida")
        else:
            print("No esta corriendo la aplicacion en el localhost:80")
            exit()

    #Manejo de errores segun exepcion
    except requests.exceptions.ConnectionError:
        print("\nError en la conexion")
        print("\nAutenticacion fallida")
    except requests.exceptions.Timeout:
        print("\nExedio el tiempo de espera de conexion")
        print("\nAutenticacion fallida")
    except KeyboardInterrupt:
        print("\nEjecucion finalizada") 
    finally:
        print("\nAutenticacion terminada")
