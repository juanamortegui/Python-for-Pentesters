import requests
from bs4 import BeautifulSoup

#URL de la aplicacion DVWA
url='http://127.0.0.1/login.php'

#Parametros que se envian en la solicitud
parametro_usuario='username'
parametro_contrasena='password'
parametro_token='user_token'

#Credenciales de la aplicacion
usuarioLogin='admin'
contrasenaLogin='password'

#Se crea el objeto para la sesion
with requests.Session() as s:

    try:
        #Se hace una solicitud get para poder parametrizar el token de usuario 
        #y las cookies de sesion
        res=s.get(url, timeout=5)
        cookies=res.headers["Set-Cookie"]
        HTML=res.text
        sopa=BeautifulSoup(HTML,"html.parser")
        token=sopa.find("form").find("input", {"name":parametro_token})["value"]

        #Se empaquetan los parametros a enviar en un diccionario
        parametros={parametro_usuario:usuarioLogin,
            parametro_contrasena:contrasenaLogin,
            parametro_token:token,
            "Login":"Login"
        }

        #Se empaquetan las cookies de sesion en un diccionario
        cabeceras={"cookie":cookies,
            "Content-Type":"application/x-www-form-urlencoded"
            }

        res=s.post(url, data=parametros, headers=cabeceras, timeout=5)
        print(res.history)
        print(res.url)
    except:
        print("Problemas para realizar la autenticacion")
    finally:
        print("Autenticacion terminada")