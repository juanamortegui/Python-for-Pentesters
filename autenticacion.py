import requests
from bs4 import BeautifulSoup

#URL de la aplicacion DVWA que corre localmente por el puerto 80
url = 'http://127.0.0.1/login.php'

#Parametros que se envian en la solicitud
parametro_usuario = 'username'
parametro_contrasena = 'password'
parametro_token = 'user_token'

#Credenciales de la aplicacion
usuario_login = 'admin'
contrasena_login = 'password'

#Se crea el objeto para la sesion
with requests.Session() as s:

    try:
        #Se hace una solicitud get para poder parametrizar el token de usuario 
        #y las cookies de sesion
        res = s.get(url, timeout=5)
        cookies = res.headers["Set-Cookie"]
        HTML = res.text
        sopa = BeautifulSoup(HTML,"html.parser")
        token = sopa.find("form").find("input", {"name":parametro_token})["value"]

        #Se empaquetan los parametros a enviar en un diccionario
        parametros = {parametro_usuario:usuario_login,
            parametro_contrasena:contrasena_login,
            parametro_token:token,
            "Login":"Login"
        }

        #Se empaquetan las cookies de sesion en un diccionario
        cabeceras = {"cookie":cookies,
            "Content-Type":"application/x-www-form-urlencoded"
        }

        res = s.post(url, data=parametros, headers=cabeceras, timeout=5)
        print(res.history)
        print(res.url)
        if "index.php" in res.url:
            print("Autenticacion exitosa")
        elif "setup.php" in res.url:
            print("Debe configurarse primero la aplicacion")
        else:
            print("Autenticacion fallida")
    except:
        print("Problemas para realizar la autenticacion")
        print("Autenticacion fallida")
    finally:
        print("Autenticacion terminada")
